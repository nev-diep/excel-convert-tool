<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>G5 Checklist Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f7f6; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .menu-bar { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        button { padding: 10px 15px; cursor: pointer; border: none; border-radius: 4px; background: #2c3e50; color: white; transition: 0.3s; }
        button:hover { background: #34495e; }
        button.active { background: #27ae60; }
        button.clear { background: #e74c3c; }
        .hidden { display: none; }
        #drop-zone { border: 2px dashed #3498db; padding: 20px; text-align: center; margin-bottom: 20px; color: #3498db; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; position: sticky; top: 0; }
        .file-list { margin: 10px 0; padding: 10px; background: #eee; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="menu-bar">
        <button class="active">Tạo Checklist G5 mới từ nhiều SVC</button>
        <button onclick="alert('Tính năng đang phát triển')">Upcoming</button>
        <button onclick="alert('Tính năng đang phát triển')">Upcoming</button>
        <button onclick="alert('Tính năng đang phát triển')">Upcoming</button>
        <button onclick="alert('Tính năng đang phát triển')">Upcoming</button>
    </div>

    <div id="main-tool">
        <div id="drop-zone">
            Kéo thả hoặc <b>Click để chọn</b> các file SVC (SVC1, SVC2...)
            <input type="file" id="file-input" multiple accept=".xlsx, .xls, .xlsm" style="display:none">
        </div>
        
        <div id="file-queue" class="hidden">
            <strong>Danh sách file (Sẽ ghép theo thứ tự từ trên xuống):</strong>
            <div id="list-container" class="file-list"></div>
            <button id="process-btn" style="background: #27ae60;">Bắt đầu ghép dữ liệu</button>
            <button class="clear" onclick="clearAll()">Clear</button>
        </div>

        <div id="result-area" class="hidden">
            <hr>
            <button id="copy-btn" style="background: #f39c12;">Sao chép kết quả (Dán vào Excel)</button>
            <div style="overflow-x: auto; max-height: 500px;">
                <table id="result-table">
                    <thead>
                        <tr>
                            <th>A (T)</th><th>B (N)</th><th>C (O)</th><th>D (Q)</th><th>E (S)</th><th>F (M)</th>
                            <th>G (V)</th><th>H (AY)</th><th>I (AZ)</th><th>J (BA)</th><th>K (BB)</th><th>L (BC)</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script>
    const fileInput = document.getElementById('file-input');
    const dropZone = document.getElementById('drop-zone');
    const processBtn = document.getElementById('process-btn');
    const tableBody = document.getElementById('table-body');
    let selectedFiles = [];

    // Mapping: T, N, O, Q, S, M, V, AY, AZ, BA, BB, BC
    const colMap = [19, 13, 14, 16, 18, 12, 21, 50, 51, 52, 53, 54];

    dropZone.onclick = () => fileInput.click();

    fileInput.onchange = (e) => {
        const files = Array.from(e.target.files).filter(f => f.name.toLowerCase().startsWith('svc'));
        selectedFiles = files.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true}));
        renderFileList();
    };

    function renderFileList() {
        const container = document.getElementById('list-container');
        container.innerHTML = selectedFiles.map((f, i) => `<div>${i+1}. ${f.name}</div>`).join('');
        document.getElementById('file-queue').classList.remove('hidden');
    }

    processBtn.onclick = async () => {
        tableBody.innerHTML = ''; 
        for (const file of selectedFiles) {
            const data = await readExcel(file);
            appendDataToTable(data);
        }
        alert("Đã gộp sát tất cả SVC! Hãy kiểm tra bảng kết quả.");
        document.getElementById('result-area').classList.remove('hidden');
    };

    function readExcel(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: "" });
                
                let allRowsFrom6 = jsonData.slice(5); // Lấy từ hàng 6
                
                // Lọc bỏ các hàng trống ở cuối mỗi file SVC trước khi trả về kết quả
                // Duyệt ngược từ dưới lên
                let lastValidIndex = -1;
                for (let i = allRowsFrom6.length - 1; i >= 0; i--) {
                    const row = allRowsFrom6[i];
                    // Kiểm tra xem hàng có ô nào chứa ký tự thực sự (không phải chỉ dấu cách) không
                    const hasData = row.some(cell => {
                        if (cell === null || cell === undefined) return false;
                        return String(cell).trim() !== ""; 
                    });

                    if (hasData) {
                        lastValidIndex = i;
                        break;
                    }
                }

                // Chỉ lấy từ hàng 6 đến hàng cuối cùng có dữ liệu thực
                const cleanedRows = lastValidIndex !== -1 ? allRowsFrom6.slice(0, lastValidIndex + 1) : [];
                resolve(cleanedRows);
            };
            reader.readAsBinaryString(file);
        });
    }

    function appendDataToTable(rows) {
        rows.forEach(row => {
            const tr = document.createElement('tr');
            colMap.forEach(colIdx => {
                const td = document.createElement('td');
                const val = row[colIdx];
                td.innerText = (val === undefined || val === null) ? '' : val;
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
    }

    document.getElementById('copy-btn').onclick = () => {
        const el = document.getElementById('table-body'); 
        const range = document.createRange();
        const sel = window.getSelection();
        sel.removeAllRanges();
        try {
            range.selectNodeContents(el);
            sel.addRange(range);
        } catch (e) {
            range.selectNode(el);
            sel.addRange(range);
        }
        if (document.execCommand('copy')) {
            alert("Đã copy dữ liệu sạch! Hãy dán vào Excel.");
        }
        sel.removeAllRanges();
    };

    function clearAll() {
        location.reload();
    }
</script>
</body>
</html>
