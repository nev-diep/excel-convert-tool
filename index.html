<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Excel Tool For Summary</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 20px; background-color: #f5f6f7; }
        .container { max-width: 1600px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .menu-bar { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 15px; }
        button { padding: 10px 18px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: 0.3s; }
        .btn-tab { background: #e0e0e0; color: #333; }
        .btn-tab.active { background: #007bff; color: white; }
        .tool-section { display: none; }
        .tool-section.active { display: block; }
        .tool-grid { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 20px; align-items: start; }
        .column { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 8px; color: #444; }
        .list-container { height: 600px; overflow-y: auto; border: 1px solid #ccc; border-radius: 6px; background: #fff; box-sizing: border-box; }
        .line-item { display: flex; align-items: center; padding: 0 10px; border-bottom: 1px solid #eee; height: 35px; box-sizing: border-box; font-size: 14px; font-family: 'Consolas', monospace; }
        .input-line { width: 100%; border: none; outline: none; background: transparent; font-family: inherit; font-size: inherit; color: #333; height: 100%; }
        .input-line:focus { background-color: #f0f7ff; }
        .out-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .btn-copy-mini { padding: 2px 5px; font-size: 10px; background: #495057; color: white; border-radius: 3px; margin-left: 5px; width: 55px; text-align: center; border: none; cursor: pointer; }
        .btn-copy-mini.copied { background: #1e7e34 !important; }
        .warning-panel { border-left: 5px solid #dc3545; color: #dc3545; font-size: 12px; font-weight: bold; }
        .warn-item { color: #dc3545; background-color: #fff5f5; }
        .action-area { margin: 15px 0; display: flex; gap: 10px; }
        .btn-green { background: #28a745; color: white; }
        .btn-orange { background: #fd7e14; color: white; }
        .btn-red { background: #dc3545; color: white; }
        #drop-zone, .upload-box { border: 2px dashed #007bff; padding: 30px; text-align: center; margin-bottom: 15px; border-radius: 8px; background: #f0f7ff; cursor: pointer; }
        .file-info { color: #28a745; margin-top: 10px; font-size: 0.9em; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        th { background: #007bff; color: white; position: sticky; top: 0; }
    </style>
</head>
<body>

<div class="container">
    <div class="menu-bar">
        <button id="tab1-btn" class="btn-tab active" onclick="showTab(1)">Táº¡o Checklist G5 Nido</button>
        <button id="tab2-btn" class="btn-tab" onclick="showTab(2)">GhÃ©p Bess vÃ o G5 Convert</button>
        <button id="tab3-btn" class="btn-tab" onclick="showTab(3)">Convert Text</button>
        <button id="tab4-btn" class="btn-tab" onclick="showTab(4)">Name Checker</button>
    </div>

    <div id="section1" class="tool-section active">
        <div id="drop-zone" onclick="document.getElementById('file-svc').click()">
            <b>Click hoáº·c KÃ©o tháº£ cÃ¡c file SVC vÃ o Ä‘Ã¢y</b>
            <input type="file" id="file-svc" multiple accept=".xlsx, .xlsm" style="display:none">
            <div id="svc-list" class="file-info"></div>
        </div>
        <div class="action-area">
            <button class="btn-green" onclick="processSVC()">Xá»­ lÃ½ dá»¯ liá»‡u</button>
            <button class="btn-orange" onclick="copyTable('table-svc-body')">Copy Káº¿t quáº£</button>
            <button class="btn-red" onclick="clearTool(1)">Clear</button>
        </div>
        <div style="overflow: auto; max-height: 500px; border: 1px solid #ddd;">
            <table>
                <thead><tr><th>ï¾Œï½¨ï½¼ï¾ï½¶ï¾™ï½±ï¾„ï¾ï¾šï½½</th><th>GG</th><th>PP</th><th>ï½¸ï¾ï¾™ï½°ï¾Œï¾Ÿåç§°</th><th>è¡¨ç¤ºåç§°</th><th>ï¾€ï½²ï¾Œï¾Ÿ</th><th>è­¦å ±ç‚¹</th><th>æ‰‹å…ƒæ“ä½œå¯</th><th>IPDå˜ä½</th><th>æœ€å°</th><th>æœ€å¤§</th><th>å°‘æ•°æ¡</th></tr></thead>
                <tbody id="table-svc-body"></tbody>
            </table>
        </div>
    </div>

    <div id="section2" class="tool-section">
        <div class="upload-box" onclick="document.getElementById('file-g5').click()">
            <b>1. Upload file G5 Convert</b>
            <input type="file" id="file-g5" accept=".xlsx, .xlsm" style="display:none">
            <div id="g5-name" class="file-info"></div>
        </div>
        <div class="upload-box" onclick="document.getElementById('file-fx').click()">
            <b>2. Upload file Checklist FX</b>
            <input type="file" id="file-fx" accept=".xlsx, .xlsm" style="display:none">
            <div id="fx-name" class="file-info"></div>
        </div>
        <div class="action-area">
            <button class="btn-green" onclick="processG5FX()">GhÃ©p dá»¯ liá»‡u</button>
            <button class="btn-orange" onclick="copyTable('table-g5fx-body')">Copy Káº¿t quáº£</button>
            <button class="btn-red" onclick="clearTool(2)">Clear</button>
        </div>
        <div style="overflow: auto; max-height: 500px; border: 1px solid #ddd;">
            <table>
                <thead>
                    <tr><th style="background:#6c757d">GG</th><th style="background:#6c757d">PP</th><th>è¡¨ç¤ºåç§°</th><th>ï¾ï¾Ÿï½²ï¾ï¾„</th><th>çŠ¶æ…‹ANA</th><th>è­¦å ±</th><th>ç™ºåœ</th><th>ä¿¡å·ç¨®åˆ¥</th><th>ä¸‹é™</th><th>ä¸Šé™</th></tr>
                </thead>
                <tbody id="table-g5fx-body"></tbody>
            </table>
        </div>
    </div>

    <div id="section3" class="tool-section">
        <div class="action-area">
            <button class="btn-orange" onclick="copyFullOutput('output-list-t3', 'copy-status-t3')">Copy All</button>
            <button class="btn-red" onclick="clearTool(3)">Clear (Esc)</button>
            <span id="copy-status-t3" style="align-self:center; font-weight:bold; color:#28a745"></span>
        </div>
        <div class="tool-grid">
            <div class="column">
                <label>Input</label>
                <div id="input-list-t3" class="list-container" onscroll="syncScroll(this, 'output-list-t3', 'warning-msg-t3')"></div>
            </div>
            <div class="column">
                <label>Output</label>
                <div id="output-list-t3" class="list-container" onscroll="syncScroll(this, 'input-list-t3', 'warning-msg-t3')"></div>
            </div>
            <div class="column">
                <label>Warning</label>
                <div id="warning-msg-t3" class="list-container warning-panel" onscroll="syncScroll(this, 'input-list-t3', 'output-list-t3')"></div>
            </div>
        </div>
    </div>

    <div id="section4" class="tool-section">
        <div class="action-area">
            <button class="btn-orange" onclick="copyFullOutput('output-list-t4', 'copy-status-t4')">Copy All</button>
            <button class="btn-red" onclick="clearTool(4)">Clear (Esc)</button>
            <span id="copy-status-t4" style="align-self:center; font-weight:bold; color:#28a745"></span>
        </div>
        <div class="tool-grid">
            <div class="column">
                <label>Input</label>
                <div id="input-list-t4" class="list-container" onscroll="syncScroll(this, 'output-list-t4', 'warning-msg-t4')"></div>
            </div>
            <div class="column">
                <label>Output</label>
                <div id="output-list-t4" class="list-container" onscroll="syncScroll(this, 'input-list-t4', 'warning-msg-t4')"></div>
            </div>
            <div class="column">
                <label>Warning</label>
                <div id="warning-msg-t4" class="list-container warning-panel" onscroll="syncScroll(this, 'input-list-t4', 'output-list-t4')"></div>
            </div>
        </div>
    </div>
</div>

<script>
const h2fMap = {'ï½±':'ã‚¢','ï½²':'ã‚¤','ï½³':'ã‚¦','ï½´':'ã‚¨','ï½µ':'ã‚ª','ï½¶':'ã‚«','ï½·':'ã‚­','ï½¸':'ã‚¯','ï½¹':'ã‚±','ï½º':'ã‚³','ï½»':'ã‚µ','ï½¼':'ã‚·','ï½½':'ã‚¹','ï½¾':'ã‚»','ï½¿':'ã‚½','ï¾€':'ã‚¿','ï¾':'ãƒ','ï¾‚':'ãƒ„','ï¾ƒ':'ãƒ†','ï¾„':'ãƒˆ','ï¾…':'ãƒŠ','ï¾†':'ãƒ‹','ï¾‡':'ãƒŒ','ï¾ˆ':'ãƒ','ï¾‰':'ãƒ','ï¾Š':'ãƒ','ï¾‹':'ãƒ’','ï¾Œ':'ãƒ•','ï¾':'ãƒ˜','ï¾':'ãƒ›','ï¾':'ãƒ','ï¾':'ãƒŸ','ï¾‘':'ãƒ ','ï¾’':'ãƒ¡','ï¾“':'ãƒ¢','ï¾”':'ãƒ¤','ï¾•':'ãƒ¦','ï¾–':'ãƒ¨','ï¾—':'ãƒ©','ï¾˜':'ãƒª','ï¾™':'ãƒ«','ï¾š':'ãƒ¬','ï¾›':'ãƒ­','ï¾œ':'ãƒ¯','ï½¦':'ãƒ²','ï¾':'ãƒ³','ï½§':'ã‚¡','ï½¨':'ã‚£','ï½©':'ã‚¥','ï½ª':'ã‚§','ï½«':'ã‚©','ï½¬':'ãƒ£','ï½­':'ãƒ¥','ï½®':'ãƒ§','ï½¯':'ãƒƒ','ï½°':'ãƒ¼','ï¾':'ã‚›','ï¾Ÿ':'ã‚œ','ï½¤':'ã€','ï½¡':'ã€‚','ï½¥':'ãƒ»','ï½¢':'ã€Œ','ï½£':'ã€'};
const f2hMap = Object.fromEntries(Object.entries(h2fMap).map(([k, v]) => [v, k]));
let svcFiles = [];

function toHalfASCII(ch) {
    const c = ch.charCodeAt(0);
    return (c >= 0xFF01 && c <= 0xFF5E) ? String.fromCharCode(c - 0xFEE0) : ch;
}
function toFullASCII(ch) {
    const c = ch.charCodeAt(0);
    return (c >= 0x21 && c <= 0x7E) ? String.fromCharCode(c + 0xFEE0) : ch;
}
function normalizeSpace(ch, mode) {
    if (mode === "half") return ch === 'ã€€' ? ' ' : ch;
    if (mode === "full") return ch === ' ' ? 'ã€€' : ch;
    return ch;
}

function focusInput(tabNum) {
    setTimeout(() => { document.querySelector(`#input-list-t${tabNum} .input-line`)?.focus(); }, 0);
}

function showTab(n) {
    document.querySelectorAll('.tool-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
    document.getElementById('section' + n).classList.add('active');
    document.getElementById('tab' + n + '-btn').classList.add('active');
    if (n >= 3) {
        initInputRows(n);
        handleProcess(n);
        focusInput(n);
    }
}

function syncScroll(el, id1, id2) {
    const top = el.scrollTop;
    document.getElementById(id1).scrollTop = top;
    document.getElementById(id2).scrollTop = top;
}

document.getElementById('file-svc').onchange = e => {
    svcFiles = Array.from(e.target.files).filter(f => f.name.toLowerCase().startsWith('svc')).sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));
    document.getElementById('svc-list').innerText = "ÄÃ£ chá»n: " + svcFiles.map(f => f.name).join(", ");
};

async function processSVC() {
    const body = document.getElementById('table-svc-body');
    body.innerHTML = "";
    const colMap = [19,13,14,16,18,12,21,50,51,52,53,54];
    for (const f of svcFiles) {
        const data = await readExcel(f);
        data.slice(5).forEach(row => {
            if (!row || row.length < 55 || !row[19]) return;
            const tr = body.insertRow();
            colMap.forEach(i => tr.insertCell().innerText = row[i] || "");
        });
    }
    alert("Xá»­ lÃ½ xong Tab 1!");
}

async function processG5FX() {
    const fileG5 = document.getElementById('file-g5').files[0];
    const fileFX = document.getElementById('file-fx').files[0];
    if (!fileG5 || !fileFX) return alert("Vui lÃ²ng upload Ä‘á»§ 2 file!");
    const dataG5 = await readExcel(fileG5);
    const dataFX = await readExcel(fileFX, 1);
    const body = document.getElementById('table-g5fx-body');
    body.innerHTML = "";
    const normalizeKey = s => processTab3(String(s || "").trim());
    const fxMap = new Map();
    dataFX.slice(1).forEach(r => r[2] && fxMap.set(normalizeKey(r[2]), r));
    dataG5.slice(1).forEach(row => {
        const fx = fxMap.get(normalizeKey(row[2])) || [];
        const tr = body.insertRow();
        [0,1,2].forEach(i => tr.insertCell().innerText = row[i] || "");
        tr.insertCell().innerText = fx[3] || "";
        tr.insertCell().innerText = fx[15] || "";
        tr.insertCell().innerText = fx[16] || "";
        tr.insertCell().innerText = fx[10] || "";
        tr.insertCell().innerText = fx[5] || "";
        tr.insertCell().innerText = fx[18] || "";
        tr.insertCell().innerText = fx[19] || "";
    });
    alert("Xá»­ lÃ½ xong Tab 2!");
}

function processTab3(line) {
    if (!line) return "";
    
    let out = "";
    // Duyá»‡t trá»±c tiáº¿p, khÃ´ng normalize Ä‘á»ƒ giá»¯ nguyÃªn Hiragana/Kanji
    for (let ch of line) {
        let c = ch;
        if (c === ',') { out += 'ï½¤'; continue; }

        const code = c.charCodeAt(0);
        if (code >= 0xFF01 && code <= 0xFF5E) {
            c = String.fromCharCode(code - 0xFEE0);
        } else if (c === 'ã€€') {
            c = ' ';
        }

        if (f2hMap[c]) {
            out += f2hMap[c];
        } else {
            out += c;
        }
    }
    // Dá»“n dáº¥u cÃ¡ch vÃ  xÃ³a khoáº£ng tráº¯ng thá»«a
    return out.replace(/ +/g, ' ').trim();
}
function processTab4(line) {
    if (!line) return "";
    let tmp = "";
    for (const ch of line) {
        let c = toFullASCII(ch);
        c = normalizeSpace(c, "full");
        if (h2fMap[c]) c = h2fMap[c];
        tmp += c;
    }
    let out = "";
    const narrowPattern = /[ï¼-ï¼™ï¼¡-ï¼ºï½-ï½šï¼ï¼ˆï¼‰ï¼œï¼ï¼šï¼ƒï¼†ï¼‹ï¼ï¼Œ]/;
    for (const ch of tmp) {
        if (ch === 'ã€€') out += ' ';
        else if (narrowPattern.test(ch)) out += toHalfASCII(ch);
        else out += ch;
    }
    return out.replace(/ +/g, ' ').replace(/ï¼/g, '-').replace(/ï¼Œ/g, 'ã€').trimEnd();
}

function initInputRows(tabNum) {
    const c = document.getElementById(`input-list-t${tabNum}`);
    if (c.children.length) return;
    for (let i = 0; i < 50; i++) addRow(tabNum, i);
}

function addRow(tabNum, idx) {
    const row = document.createElement('div');
    row.className = 'line-item';
    const input = document.createElement('input');
    input.className = 'input-line';
    input.dataset.idx = idx;
    input.oninput = () => handleProcess(tabNum);
    input.onpaste = e => handlePaste(e, tabNum);
    row.appendChild(input);
    document.getElementById(`input-list-t${tabNum}`).appendChild(row);
}

function handlePaste(e, tabNum) {
    e.preventDefault();
    const lines = e.clipboardData.getData('text').split(/\r?\n/);
    const c = document.getElementById(`input-list-t${tabNum}`);
    c.innerHTML = "";
    lines.forEach((l, i) => {
        addRow(tabNum, i);
        c.querySelectorAll('.input-line')[i].value = l;
    });
    for (let i = 0; i < 15; i++) addRow(tabNum, lines.length + i);
    handleProcess(tabNum);
    focusInput(tabNum);
}

function handleProcess(tabNum) {
    const inputs = document.querySelectorAll(`#input-list-t${tabNum} .input-line`);
    const out = document.getElementById(`output-list-t${tabNum}`);
    const warn = document.getElementById(`warning-msg-t${tabNum}`);
    out.innerHTML = ""; warn.innerHTML = "";
    inputs.forEach(inp => {
        const res = tabNum === 3 ? processTab3(inp.value) : processTab4(inp.value);
        const oRow = document.createElement('div');
        oRow.className = 'line-item';
        if (inp.value.trim()) {
            const span = document.createElement('span');
            span.className = 'out-text';
            span.innerText = res;
            const btn = document.createElement('button');
            btn.className = 'btn-copy-mini';
            btn.innerText = 'Copy';
            btn.dataset.text = res;
            btn.onclick = () => copyLine(btn.dataset.text, btn);
            oRow.append(span, btn);
        }
        out.appendChild(oRow);
        const wRow = document.createElement('div');
        wRow.className = 'line-item warn-item';
if (res.trim() !== "") {
            let warnings = [];

            if (tabNum === 3) {
                const fullWidthKatakanaOnly = /[\u30A1-\u30FC]/;
                
            if (fullWidthKatakanaOnly.test(res)) {
                const errorChar = res.match(fullWidthKatakanaOnly)[0];
                warnings.push(`ğŸš« CÃ²n kÃ½ tá»± Katakana chÆ°a chuyá»ƒn: "${errorChar}"`);
                }
            } else {
                // Tab 4: Cáº£nh bÃ¡o dáº¥u cÃ¡ch vÃ  lá»—i ná»‘i
                if (res.includes("  ")) warnings.push("ğŸš« Space x2");
                if (/[ã-ã‚–ã‚¡-ãƒºä¸€-é¾¯]-[ã-ã‚–ã‚¡-ãƒºä¸€-é¾¯]/.test(res)) warnings.push("ğŸš« Lá»—i ná»‘i -");
            }

            // Cáº£nh bÃ¡o chung cho dáº¥u ï½° vÃ  dáº¥u gáº¡ch ngang toÃ n giÃ¡c
            if (/(?:[A-Za-z0-9]ï½°|ï½°[A-Za-z0-9])/.test(res)) warnings.push("ğŸš« Lá»—i ï½°");
            if (/ï¼/.test(res)) warnings.push("ğŸš« Full-width dash");

            wRow.innerText = warnings.join(" ");
        }
        warn.appendChild(wRow);
    });
}

function copyLine(text, btn) {
    navigator.clipboard.writeText(text);
    btn.classList.add('copied');
    btn.innerText = "Copied";
    setTimeout(() => { btn.classList.remove('copied'); btn.innerText = "Copy"; }, 500);
}

function copyFullOutput(id, statusId) {
    const t = [...document.querySelectorAll(`#${id} .out-text`)].map(e => e.innerText).join('\n');
    navigator.clipboard.writeText(t);
    document.getElementById(statusId).innerText = "ÄÃ£ copy toÃ n bá»™! âœ…";
    setTimeout(() => document.getElementById(statusId).innerText = "", 1000);
}

function clearTool(n) {
    if (n >= 3) {
        document.getElementById(`input-list-t${n}`).innerHTML = "";
        initInputRows(n);
        handleProcess(n);
        focusInput(n);
    } else {
        document.getElementById('table-svc-body').innerHTML = "";
        document.getElementById('table-g5fx-body').innerHTML = "";
    }
}

function readExcel(file, sheetIdx = 0) {
    return new Promise(res => {
        const r = new FileReader();
        r.onload = e => {
            const wb = XLSX.read(e.target.result, { type: 'binary' });
            res(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[sheetIdx]], { header: 1, defval: "" }));
        };
        r.readAsBinaryString(file);
    });
}

function copyTable(id) {
    const el = document.getElementById(id);
    const r = document.createRange();
    r.selectNode(el);
    const s = window.getSelection();
    s.removeAllRanges();
    s.addRange(r);
    document.execCommand('copy');
    alert("ÄÃ£ copy báº£ng dá»¯ liá»‡u!");
}

document.addEventListener('keydown', e => {
    if (e.key === "Escape") {
        const a = document.querySelector('.tool-section.active');
        if (a) clearTool(parseInt(a.id.replace('section', '')));
    }
});
</script>
</body>
</html>
