<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hệ thống Tool Tổng hợp G5</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 20px; background-color: #f5f6f7; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .menu-bar { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 15px; }
        button { padding: 10px 18px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: 0.3s; }
        .btn-tab { background: #e0e0e0; color: #333; }
        .btn-tab.active { background: #007bff; color: white; }
        .tool-section { display: none; }
        .tool-section.active { display: block; }
        
        #drop-zone, .upload-box { border: 2px dashed #007bff; padding: 30px; text-align: center; margin-bottom: 15px; border-radius: 8px; background: #f0f7ff; cursor: pointer; position: relative; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; white-space: nowrap; }
        th { background: #007bff; color: white; position: sticky; top: 0; }
        
        .convert-container { max-width: 800px; margin: 0 auto; }
        textarea { width: 100%; height: 150px; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; box-sizing: border-box; resize: vertical; margin-bottom: 10px; }
        
        #warning-msg, #warning-msg-t4 { 
            color: #dc3545; 
            font-weight: bold;
            font-size: 0.95em; 
            margin-top: 20px; 
            display: none; 
            background: #fff; 
            padding: 15px; 
            border-radius: 5px; 
            border-left: 5px solid #dc3545;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            line-height: 1.6;
        }
        
        .action-area { margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-green { background: #28a745; color: white; }
        .btn-orange { background: #fd7e14; color: white; }
        .btn-red { background: #dc3545; color: white; }
        .file-info { color: #28a745; margin-top: 10px; font-weight: normal; font-size: 0.9em; }
        
        .err-highlight { color: #28a745 !important; font-weight: 900; font-size: 1.1em; text-decoration: underline; }
        .space-err { background-color: #e8f5e9; border: 1px dashed #28a745; color: #28a745 !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="menu-bar">
        <button id="tab1-btn" class="btn-tab active" onclick="showTab(1)">Checklist G5 từ SVC</button>
        <button id="tab2-btn" class="btn-tab" onclick="showTab(2)">Ghép bess vào G5</button>
        <button id="tab3-btn" class="btn-tab" onclick="showTab(3)">Convert Full-Half Width</button>
        <button id="tab4-btn" class="btn-tab" onclick="showTab(4)">Graph Name (VBA Mode)</button>
        <button class="btn-tab" disabled>Upcoming</button>
    </div>

    <div id="section1" class="tool-section active">... (Giữ nguyên nội dung Tab 1 như cũ) ...</div>
    <div id="section2" class="tool-section">... (Giữ nguyên nội dung Tab 2 như cũ) ...</div>

    <div id="section3" class="tool-section">
        <div class="convert-container">
            <label><b>Nhập text Tiếng Nhật:</b></label>
            <textarea id="inputText" placeholder="Ví dụ: FEｰ10-1"></textarea>
            <label><b>Kết quả:</b></label>
            <textarea id="outputText" readonly></textarea>
            <div class="action-area">
                <button class="btn-orange" onclick="copyConvertResult('outputText')">Sao chép kết quả</button>
                <button class="btn-red" onclick="clearTool(3)">Clear</button>
                <span id="copy-status" style="margin-left:10px; align-self:center; font-weight:bold;"></span>
            </div>
            <div id="warning-msg"></div>
        </div>
    </div>

    <div id="section4" class="tool-section">
        <div class="convert-container">
            <label><b>Nhập Graph Name (Logic VBA):</b></label>
            <textarea id="inputTextT4" placeholder="Nhập dữ liệu từ cột D Excel vào đây..."></textarea>
            
            <label><b>Kết quả sau xử lý (Cột E):</b></label>
            <textarea id="outputTextT4" readonly placeholder="Tự động thu gọn khoảng trắng và convert ký tự..."></textarea>
            
            <div class="action-area">
                <button class="btn-orange" onclick="copyConvertResult('outputTextT4')">Sao chép kết quả</button>
                <button class="btn-red" onclick="clearTool(4)">Clear</button>
                <span id="copy-status-t4" style="margin-left:10px; align-self:center; font-weight:bold;"></span>
            </div>
            <div id="warning-msg-t4"></div>
        </div>
    </div>
</div>

<script>
    // --- MAP HỖ TRỢ VBA LOGIC ---
    const vbaWideMap = {
        '／': '/', '　': ' ', '（': '(', '）': ')', '「': '[', '」': ']', '＜': '<', '＞': '>', 
        '：': ':', '＃': '#', '＆': '&', '＋': '+', '＝': '=', '，': '、', '－': '-'
    };

    function showTab(n) {
        document.querySelectorAll('.tool-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
        document.getElementById('section' + n).classList.add('active');
        document.getElementById('tab' + n + '-btn').classList.add('active');
    }

    function clearTool(n) {
        if (n === 3) {
            document.getElementById('inputText').value = ""; document.getElementById('outputText').value = "";
            document.getElementById('warning-msg').style.display = "none";
        } else if (n === 4) {
            document.getElementById('inputTextT4').value = ""; document.getElementById('outputTextT4').value = "";
            document.getElementById('warning-msg-t4').style.display = "none";
        }
    }

    // Logic xử lý chính cho Tab 4 (Dựa trên VBA GraphName)
    document.getElementById('inputTextT4').addEventListener('input', function() {
        const rawText = this.value;
        if (!rawText) {
            document.getElementById('outputTextT4').value = "";
            document.getElementById('warning-msg-t4').style.display = "none";
            return;
        }

        const processedLines = rawText.split('\n').map(line => {
            let res = line;
            
            // 1. Convert Wide to Narrow cho các ký tự trong Pattern (Số, Chữ, Ký tự đặc biệt)
            // Chuyển toàn bộ số và chữ Full-width sang Half-width
            res = res.replace(/[０-９Ａ-Ｚａ-ｚ]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
            
            // 2. Thay thế các ký tự đặc biệt theo Map VBA
            for (let key in vbaWideMap) {
                res = res.split(key).join(vbaWideMap[key]);
            }

            // 3. Xử lý khoảng trắng: Thu gọn nhiều space thành 1 (Do While InStr... > 0)
            res = res.replace(/\s+/g, ' ');

            // 4. RTrim
            return res.trimEnd();
        });

        document.getElementById('outputTextT4').value = processedLines.join('\n');
    });

    // Hàm copy dùng chung
    function copyConvertResult(id) {
        const area = document.getElementById(id);
        area.select();
        navigator.clipboard.writeText(area.value).then(() => {
            alert("Đã copy kết quả!");
        });
    }

    // (Giữ lại toàn bộ logic Tab 1, 2, 3 từ các phiên bản trước của bạn ở đây)
    // ...
</script>
</body>
</html>
